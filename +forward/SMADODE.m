function out = SMADODE(t, Y, E, free_lig)
% Deterministic part of the TGFb/SMAD model. 
%
% Pars:
% t:                            simulation time
% Y (102 * nPaths x 1 array):   current state of the model 
% E (obj:expConditions):        experimental conditions (see expConditions)
% free_lig:                     free ligand concentration
%
% Return values:
% out (32 * nPaths x 1 array):  evaluation of the deterministic RHS at the 
%                               current state
import forward.expConditions

if t<0
    return
end
nDet = 23;
nPData = 102;

nIn = length(Y);
assert(mod(nIn, nPData) == 0)

nPaths = nIn/nPData;

pI = (0:(nPaths-1)).' * nPData;
dI = (0:(nPaths-1)).' * nDet;

out = zeros(nDet * nPaths, 1);

if ~exist('free_lig', 'var')
    free_lig = Y(pI+5);
end

E_K_k_R1_production = Y(pI + nDet + 3) .* Y(pI + nDet + 37) ...
   .* Y(pI + nDet + 43) ./ ((Y(pI + nDet + 17) + 1) .* Y(pI + nDet + 37) ...
    + Y(pI + nDet + 43)); 
E_K_k_R2_production = Y(pI + nDet + 4) .* Y(pI + nDet + 38) ...
    .* Y(pI + nDet + 44) ./ ((Y(pI + nDet + 18) + 1) .* Y(pI + nDet +38) ...
    + Y(pI + nDet + 44)); 
E_K_k_S2_production = Y(pI + nDet + 7) .* Y(pI + nDet + 45) ...
    .* (Y(pI + nDet + 6) + Y(pI + nDet + 5) + Y(pI + nDet + 45)) ...
    ./ (Y(pI + nDet + 5) + Y(pI + nDet + 45) + 2 * Y(pI + nDet + 6));
E_K_k_S4_production = Y(pI + nDet + 10) .* Y(pI + nDet + 46) ...
    .* (Y(pI + nDet + 9) + Y(pI + nDet + 8) + Y(pI + nDet + 46)) ...
    ./ (Y(pI + nDet + 8) + Y(pI + nDet + 46) + 2 * Y(pI + nDet + 9));
E_K_kb_R1_activation = Y(pI + nDet + 48) .* Y(pI + nDet + 19);
E_K_kb_R2_activation = Y(pI + nDet + 49) .* Y(pI + nDet + 20);
E_K_kb_Seq_S7_Rec = Y(pI + nDet + 50) .* Y(pI + nDet + 23);

%% right hand side

out(dI+1) = E_K_k_R1_production + E_K_kb_R1_activation.*Y(pI+8) + Y(pI+38).*Y(pI+67).*Y(pI+10) ...
    + Y(pI+39).*Y(pI+75).*Y(pI+10) + Y(pI+40).*Y(pI+60).*Y(pI+3) ...
    - Y(pI+60).*Y(pI+1) - Y(pI+71).*Y(pI+1).*Y(pI+7);

out(dI+2) = E_K_k_R2_production + E.Reaction_kickstart(t)* E_K_kb_R2_activation.*Y(pI+7) ...
    + Y(pI+39).*Y(pI+75).*Y(pI+10) + Y(pI+41).*Y(pI+61).*Y(pI+4) ...
    - Y(pI+61).*Y(pI+2) - Y(pI+72).*E.Reaction_kickstart(t).*Y(pI+2).*free_lig;

out(dI+3) = -Y(pI+40).*Y(pI+60).*Y(pI+3) + Y(pI+59).*Y(pI+9) ...
    + Y(pI+60).*Y(pI+1) - Y(pI+66).*Y(pI+3) + Y(pI+67).*Y(pI+9) + Y(pI+75).*Y(pI+9);

out(dI+4) = -Y(pI+41).*Y(pI+61).*Y(pI+4) + Y(pI+59).*Y(pI+9) ...
    + Y(pI+61).*Y(pI+2) + Y(pI+66).*Y(pI+9) - Y(pI+67).*Y(pI+4) + Y(pI+75).*Y(pI+9);

out(dI+5) = E.BolusInjection(t, E.k_inj1, E.k_inj2) ...
    + E.K_BolusInjection2 + E.K_BolusInjection3 ...
    + E_K_kb_R2_activation * E.Reaction_kickstart(t) ...
    .* Y(pI+7)./Y(pI+63) ...
    - (E.K_Wash + E.K_Wash2).* free_lig ...
    - E.Reaction_kickstart(t) * free_lig ...
    .* Y(pI+72) .* Y(pI+2) ./ Y(pI+63);

out(dI+6) = Y(pI+38).*Y(pI+67).*Y(pI+10) + Y(pI+59).*Y(pI+9) ...
    + Y(pI+66).*Y(pI+9) + Y(pI+67).*Y(pI+9) - Y(pI+75).*Y(pI+6);

out(dI+7) = E_K_kb_R1_activation.*Y(pI+8) - E_K_kb_R2_activation*E.Reaction_kickstart(t).*Y(pI+7) ...
    - Y(pI+71).*Y(pI+1).*Y(pI+7) + Y(pI+72)*E.Reaction_kickstart(t).*Y(pI+2).*free_lig;

out(dI+8) = -E_K_kb_R1_activation.*Y(pI+8) + E_K_kb_Seq_S7_Rec.*Y(pI+10) - Y(pI+37).*Y(pI+60).*Y(pI+8) ...
    + Y(pI+71).*Y(pI+1).*Y(pI+7) - Y(pI+73).*Y(pI+8).*Y(pI+18);

out(dI+9) = Y(pI+37).*Y(pI+60).*Y(pI+8) - Y(pI+59).*Y(pI+9) ...
    - Y(pI+66).*Y(pI+9) - Y(pI+67).*Y(pI+9) - Y(pI+75).*Y(pI+9);

out(dI+10) = -E_K_kb_Seq_S7_Rec.*Y(pI+10) - Y(pI+38).*Y(pI+67).*Y(pI+10) ...
    - Y(pI+39).*Y(pI+75).*Y(pI+10) + Y(pI+73).*Y(pI+8).*Y(pI+18);

out(dI+11) = Y(pI+28).*Y(pI+19)/2 - Y(pI+29).*Y(pI+11) + 3*Y(pI+44).*Y(pI+65).*Y(pI+15) ...
    - 3*Y(pI+45).*Y(pI+74).*Y(pI+11).^3 - Y(pI+64)*(E.K_Rec_inhibitor*E.K_effective - 1).*Y(pI+9).*Y(pI+12) ...
    + 2*Y(pI+65).*Y(pI+14) - Y(pI+68).*Y(pI+11) + Y(pI+68).*Y(pI+14) + 2*Y(pI+68).*Y(pI+15) ...
    + 2*Y(pI+69).*Y(pI+14) - 2*Y(pI+74).*Y(pI+11).^2.*Y(pI+13);

out(dI+12) = E_K_k_S2_production + Y(pI+28).*Y(pI+22)/2 - Y(pI+29).*Y(pI+12) ...
    + Y(pI+64)*(E.K_Rec_inhibitor*E.K_effective - 1).*Y(pI+9).*Y(pI+12) - Y(pI+68).*Y(pI+12);

out(dI+13) = E_K_k_S4_production + Y(pI+31).*Y(pI+23)/2 - Y(pI+32).*Y(pI+13) ...
    + Y(pI+65).*Y(pI+14) + Y(pI+68).*Y(pI+14) - Y(pI+69).*Y(pI+13) - Y(pI+74).*Y(pI+11).^2.*Y(pI+13);

out(dI+14) = -Y(pI+34).*Y(pI+14) - Y(pI+65).*Y(pI+14) - Y(pI+68).*Y(pI+14) ...
    - Y(pI+69).*Y(pI+14) + Y(pI+74).*Y(pI+11).^2.*Y(pI+13);

out(dI+15) = -Y(pI+34).*Y(pI+15) - Y(pI+44).*Y(pI+65).*Y(pI+15) ...
    + Y(pI+45).*Y(pI+74).*Y(pI+11).^3 - Y(pI+68).*Y(pI+15);

out(dI+16) = Y(pI+35).*Y(pI+17)/2 - Y(pI+77).*Y(pI+16);


out(dI+17) = E.K_DRB_index*E.K_S7_KD_index*(Y(pI+62).*subplus(Y(pI+20)).^Y(pI+36)./(subplus(Y(pI+25)).^Y(pI+36) ...
    + subplus(Y(pI+20)).^Y(pI+36)) + Y(pI+78)) - Y(pI+35).*Y(pI+17) - Y(pI+76).*Y(pI+17);


out(dI+18) = E_K_kb_Seq_S7_Rec.*Y(pI+10) + Y(pI+38).*Y(pI+67).*Y(pI+10) + ...
    Y(pI+39).*Y(pI+75).*Y(pI+10) + Y(pI+58).*Y(pI+16) ...
    - Y(pI+70).*Y(pI+18) - Y(pI+73).*Y(pI+8).*Y(pI+18);

out(dI+19) = -Y(pI+28).*Y(pI+19) + 2*Y(pI+29).*Y(pI+11) + 3*Y(pI+44).*Y(pI+65).*Y(pI+21) ...
    - 3*Y(pI+45).*Y(pI+74).*Y(pI+19).^3 + Y(pI+47).*Y(pI+57).*Y(pI+20) ...
    - Y(pI+57).*Y(pI+19) + 2*Y(pI+65).*Y(pI+20) - Y(pI+68).*Y(pI+19) + Y(pI+68).*Y(pI+20) ...
    + 2*Y(pI+68).*Y(pI+21) + 2*Y(pI+69).*Y(pI+20) - 2*Y(pI+74).*Y(pI+19).^2.*Y(pI+23);

out(dI+20) = 2*Y(pI+34).*Y(pI+14) - Y(pI+47).*Y(pI+57).*Y(pI+20) ...
    - Y(pI+65).*Y(pI+20) - Y(pI+68).*Y(pI+20) - Y(pI+69).*Y(pI+20) + Y(pI+74).*Y(pI+19).^2.*Y(pI+23);

out(dI+21) = 2*Y(pI+34).*Y(pI+15) - Y(pI+44).*Y(pI+65).*Y(pI+21) ...
    + Y(pI+45).*Y(pI+74).*Y(pI+19).^3 - Y(pI+68).*Y(pI+21);

out(dI+22) = -Y(pI+28).*Y(pI+22) + 2*Y(pI+29).*Y(pI+12) ...
    + Y(pI+47).*Y(pI+57).*Y(pI+20) + Y(pI+57).*Y(pI+19) - Y(pI+68).*Y(pI+22);

out(dI+23) = -Y(pI+31).*Y(pI+23) + 2*Y(pI+32).*Y(pI+13) + Y(pI+47).*Y(pI+57).*Y(pI+20) ...
    + Y(pI+65).*Y(pI+20) + Y(pI+68).*Y(pI+20) - Y(pI+69).*Y(pI+23) - Y(pI+74).*Y(pI+19).^2.*Y(pI+23);

